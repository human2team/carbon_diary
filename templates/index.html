{% extends "base.html" %}
{% block content %}
<div class="card">
  <!-- ì˜¤ëŠ˜ ê¸°ë¡ ì…ë ¥ í¼ -->
  <h2>ì˜¤ëŠ˜ì˜ í™œë™ ê¸°ë¡í•˜ê¸°</h2>
  <form method="POST" class="form">
    <label>ì˜¤ëŠ˜ ì‹ì‚¬ëŠ” ë¬´ì—‡ì„ í•˜ì…¨ë‚˜ìš”? (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label>
    <div class="card-group">
      <label class="card-option">
        <input type="checkbox" name="meal[]" value="ì†Œê³ ê¸°">
        <span>ì†Œê³ ê¸° ğŸ¥©</span>
      </label>
      <label class="card-option">
        <input type="checkbox" name="meal[]" value="ë¼ì§€ê³ ê¸°">
        <span>ë¼ì§€ê³ ê¸° ğŸ–</span>
      </label>
      <label class="card-option">
        <input type="checkbox" name="meal[]" value="ë‹­ê³ ê¸°">
        <span>ë‹­ê³ ê¸° ğŸ—</span>
      </label>
      <label class="card-option">
        <input type="checkbox" name="meal[]" value="ì±„ì‹">
        <span>ì±„ì‹ ğŸ¥—</span>
      </label>
      <label class="card-option">
        <input type="checkbox" name="meal[]" value="ìƒì„ ">
        <span>ìƒì„  ğŸŸ</span>
      </label>
      <label class="card-option">
        <input type="checkbox" name="meal[]" value="ë¹µ">
        <span>ë¹µ ğŸ¥–</span>
      </label>
    </div>

    <label>ì–´ë–¤ êµí†µìˆ˜ë‹¨ì„ ì´ìš©í–ˆë‚˜ìš”?</label>
    <div class="card-group">
      <label class="card-option">
        <input type="radio" name="transport" value="ìë™ì°¨">
        <span>ìë™ì°¨ ğŸš—</span>
      </label>
      <label class="card-option">
        <input type="radio" name="transport" value="ë²„ìŠ¤">
        <span>ë²„ìŠ¤ ğŸšŒ</span>
      </label>
      <label class="card-option">
        <input type="radio" name="transport" value="ê¸°ì°¨">
        <span>ê¸°ì°¨ ğŸš†</span>
      </label>
      <label class="card-option">
        <input type="radio" name="transport" value="ë„ë³´">
        <span>ë„ë³´ ğŸš¶</span>
      </label>
      <label class="card-option">
        <input type="radio" name="transport" value="ë¹„í–‰ê¸°">
        <span>ë¹„í–‰ê¸° âœˆï¸</span>
      </label>
      <label class="card-option">
        <input type="radio" name="transport" value="ìì „ê±°">
        <span>ìì „ê±° ğŸš´</span>
      </label>
    </div>

    <label>ì»´í“¨í„°ë¥¼ ëª‡ ì‹œê°„ ì‚¬ìš©í–ˆë‚˜ìš”?</label>
    <input type="number" name="computer" placeholder="ì˜ˆ: 5" class="input-field" min="0" max="24">

    <button type="submit" class="btn">ì €ì¥í•˜ê¸°</button>
  </form>
</div>

<!-- ì˜¤ëŠ˜ì˜ íƒ„ì†Œ ë°œìêµ­ -->
{% if latest %}
<div class="card footprint">
  <h2>ì˜¤ëŠ˜ì˜ íƒ„ì†Œ ë°°ì¶œëŸ‰</h2>
  <p class="value">{{ latest.emissions }} kg</p>
  <div class="formula">
    <h3>ê³„ì‚°ì‹</h3>
    <ul>
      <li>ìŒì‹: {{ latest.meal_emission }} kg COâ‚‚e</li>
      <li>êµí†µ: {{ latest.transport_emission }} kg COâ‚‚e</li>
      <li>ì»´í“¨í„°: {{ latest.computer_emission }} kg COâ‚‚e</li>
    </ul>
    <p>ì´í•©: {{ latest.meal_emission }} + {{ latest.transport_emission }} + {{ latest.computer_emission }} = <b>{{ latest.emissions }} kg COâ‚‚e</b></p>
  </div>
</div>
{% endif %}

<!-- ë‚´ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ -->
{% if all_entries %}
<div class="card records">
  <h2>ë‚´ ê¸°ë¡</h2>
  <ul>
    {% for entry in all_entries %}
    <li>
      {{ entry.date }} - {{ entry.meal }} - {{ entry.transport }} - {{ entry.computer }}ì‹œê°„ - 
      <span class="emission-detail" style="cursor:pointer;color:#007bff;text-decoration:underline;" onclick="showFormula('{{ entry.meal }}', '{{ entry.transport }}', '{{ entry.computer }}', '{{ entry.emissions }}')">{{ entry.emissions }} kg</span>
      <form action="/delete/{{ entry.id }}" method="POST" style="display:inline;">
        <button type="submit" class="btn-delete">ì‚­ì œ</button>
      </form>
    </li>
    {% endfor %}
  </ul>
{% endif %}
<!-- ê³„ì‚°ì‹ íŒì—…ê³¼ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¡°ê±´ë¬¸ ë°”ê¹¥ì— ìœ„ì¹˜ -->
<div id="formulaModal" style="display:none;position:fixed;top:30%;left:50%;transform:translate(-50%,-30%);background:#fff;border:1px solid #ccc;padding:20px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
  <h3>ê³„ì‚°ì‹</h3>
  <div id="formulaContent"></div>
  <button onclick="document.getElementById('formulaModal').style.display='none'">ë‹«ê¸°</button>
</div>
<script>
  function showFormula(meal, transport, computer, emissions) {
    // ìŒì‹ ê³„ì‚°ì‹
    var mealArr = meal.split(', ');
    var mealFormula = mealArr.map(function(m) {
      if (m === 'ì†Œê³ ê¸°') return 'ì†Œê³ ê¸°(13)';
      if (m === 'ë¼ì§€ê³ ê¸°') return 'ë¼ì§€ê³ ê¸°(3.5)';
      if (m === 'ë‹­ê³ ê¸°') return 'ë‹­ê³ ê¸°(3)';
      if (m === 'ìŒ€') return 'ìŒ€(2)';
      if (m === 'ì±„ì†Œ') return 'ì±„ì†Œ(0.5)';
      if (m === 'ìƒì„ ') return 'ìƒì„ (2.5)';
      return m;
    }).join(' + ');
    var mealText = mealFormula ? mealFormula : 'ì—†ìŒ';

    // êµí†µ ê³„ì‚°ì‹
    var transportVal = 0;
    var transportFormula = '';
    var distance = 10; // ê¸°ë³¸ê°’(10km)
    if (transport === 'ìë™ì°¨') { transportVal = 0.21 * distance; transportFormula = 'ìë™ì°¨(0.21Ã—' + distance + ')'; }
    else if (transport === 'ë²„ìŠ¤') { transportVal = 0.05 * distance; transportFormula = 'ë²„ìŠ¤(0.05Ã—' + distance + ')'; }
    else if (transport === 'ê¸°ì°¨') { transportVal = 0.04 * distance; transportFormula = 'ê¸°ì°¨(0.04Ã—' + distance + ')'; }
    else if (transport === 'ë¹„í–‰ê¸°') { transportVal = 0.15 * distance; transportFormula = 'ë¹„í–‰ê¸°(0.15Ã—' + distance + ')'; }
    else if (transport === 'ë„ë³´' || transport === 'ìì „ê±°') { transportVal = 0.01 * distance; transportFormula = transport + '(0.01Ã—' + distance + ')'; }
    else { transportFormula = 'ê¸°ë³¸ê°’(0.01Ã—' + distance + ')'; transportVal = 0.01 * distance; }

    // ì»´í“¨í„° ê³„ì‚°ì‹
    var computerVal = parseFloat(computer);
    var computerEmission = (100/1000) * computerVal * 0.5;
    var computerFormula = '100WÃ—' + computerVal + 'ì‹œê°„Ã—0.5';

    var html = `<ul>`;
    html += `<li>ìŒì‹: ` + mealText + `</li>`;
    html += `<li>êµí†µ: ` + transportFormula + `</li>`;
    html += `<li>ì»´í“¨í„°: ` + computerFormula + `</li>`;
    html += `</ul>`;
    html += `<p>ì´í•©: (` + mealText + `) + (` + transportFormula + `) + (` + computerFormula + `) = <b>` + emissions + ` kg COâ‚‚e</b></p>`;
    document.getElementById('formulaContent').innerHTML = html;
    document.getElementById('formulaModal').style.display = 'block';
  }
</script>
{% endblock %}
